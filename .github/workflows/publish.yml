name: Publish Docker Image and Helm Chart

# This workflow automatically builds and publishes Docker images to Docker Hub
# and Helm charts to GitHub Pages whenever a Git tag is created.
# 
# Prerequisites:
# - Docker Hub secrets: DOCKER_HUB_USERNAME, DOCKER_HUB_TOKEN
# - GitHub Pages must be enabled in repository settings
#
# Usage:
#   git tag 1.0.0
#   git push origin 1.0.0

on:
  push:
    tags:
      # Match semantic version tags without 'v' prefix (e.g., 1.0.0, 1.2.3-beta.1)
      - '[0-9]+.[0-9]+.[0-9]+*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for GitHub Pages deployment
      packages: write  # Required for Docker Hub push
    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history to ensure all files are available

      # Step 2: Validate Git tag format (semantic versioning without 'v' prefix)
      - name: Validate Git tag
        run: |
          if ! [[ "${{ github.ref_name }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Error: Tag must be semantic version without 'v' prefix (e.g., 1.0.0)"
            echo "Valid formats: 1.0.0, 1.2.3, 2.0.0-beta.1, 1.0.0+abc123"
            exit 1
          fi
          echo "✓ Validated tag: ${{ github.ref_name }}"

      # Step 3: Set up Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 4: Authenticate with Docker Hub using access token
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          registry: docker.io
        continue-on-error: false

      # Step 5: Build and push Docker image with version and latest tags
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            iklob1/pylight:${{ github.ref_name }}
            iklob1/pylight:latest
          platforms: linux/amd64
        continue-on-error: false

      # Step 6: Install Helm CLI for chart packaging
      - name: Set up Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      # Step 7: Clean up macOS resource fork files (._*) that cause Helm issues
      - name: Clean up macOS resource forks
        run: |
          find charts/pylight -name "._*" -type f -delete || true
          find charts/pylight -name ".DS_Store" -type f -delete || true
          echo "✓ Cleaned up macOS resource fork files"

      # Step 8: Update Chart.yaml version to match Git tag
      - name: Update Chart.yaml version
        run: |
          VERSION="${{ github.ref_name }}"
          CHART_FILE="charts/pylight/Chart.yaml"
          
          # Verify file exists before update
          if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart.yaml not found at $CHART_FILE"
            exit 1
          fi
          
          # Use yq if available, otherwise use sed
          if command -v yq &> /dev/null; then
            yq eval ".version = \"$VERSION\"" -i "$CHART_FILE"
          else
            # Use sed with backup and verify it worked
            sed -i.bak "s/^version:.*/version: $VERSION/" "$CHART_FILE"
            rm -f "$CHART_FILE.bak"
          fi
          
          # Verify the update worked
          if ! grep -q "^version: $VERSION" "$CHART_FILE"; then
            echo "Error: Failed to update Chart.yaml version to $VERSION"
            echo "Current Chart.yaml content:"
            cat "$CHART_FILE"
            exit 1
          fi
          
          echo "✓ Updated Chart.yaml version to $VERSION"
          echo "Chart.yaml version line:"
          grep "^version:" "$CHART_FILE"

      # Step 9: Package Helm chart into .tgz archive
      - name: Package Helm chart
        run: |
          mkdir -p charts-dist
          CHART_DIR="charts/pylight"
          CHART_FILE="$CHART_DIR/Chart.yaml"
          
          # Debug: Show current directory and verify Chart.yaml exists
          echo "Current directory: $(pwd)"
          echo "Chart directory: $CHART_DIR"
          echo ""
          echo "Listing chart directory:"
          ls -la "$CHART_DIR/" || true
          echo ""
          
          # Verify Chart.yaml exists and is readable
          if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart.yaml not found at $CHART_FILE"
            echo "Files in chart directory:"
            find "$CHART_DIR" -type f || true
            exit 1
          fi
          
          echo "✓ Chart.yaml found"
          echo "Chart.yaml content:"
          cat "$CHART_FILE"
          echo ""
          
          # Verify it's valid YAML
          if ! python3 -c "import yaml; yaml.safe_load(open('$CHART_FILE'))" 2>/dev/null; then
            echo "Error: Chart.yaml is not valid YAML"
            exit 1
          fi
          echo "✓ Chart.yaml is valid YAML"
          echo ""
          
          # Package the chart (this will also validate the chart structure)
          echo "Packaging chart from: $CHART_DIR"
          if ! helm package "$CHART_DIR" --destination ./charts-dist; then
            echo "Error: Helm chart packaging failed"
            echo "Trying with absolute path..."
            ABS_CHART_DIR="$(cd "$CHART_DIR" && pwd)"
            helm package "$ABS_CHART_DIR" --destination "$(pwd)/charts-dist" || exit 1
          fi
          echo "✓ Helm chart packaged successfully"

      # Step 10: Check if chart version already exists (prevent overwrite)
      - name: Check version conflict
        run: |
          VERSION="${{ github.ref_name }}"
          INDEX_URL="https://iklobato.github.io/pylight/charts/index.yaml"
          # Download existing index if it exists
          curl -s "$INDEX_URL" -o existing-index.yaml || touch existing-index.yaml
          # Check if version already exists
          if grep -q "version: $VERSION" existing-index.yaml 2>/dev/null; then
            echo "Error: Chart version $VERSION already exists in repository"
            echo "Cannot publish duplicate version. Use a new version number."
            exit 1
          fi
          echo "✓ Version $VERSION is available for publishing"

      # Step 11: Generate or update Helm repository index
      - name: Generate repository index
        run: |
          REPO_URL="https://iklobato.github.io/pylight/charts"
          if ! helm repo index ./charts-dist --url "$REPO_URL" --merge existing-index.yaml; then
            echo "Error: Failed to generate repository index"
            exit 1
          fi
          echo "✓ Repository index generated successfully"

      # Step 12: Deploy chart package and index to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./charts-dist
          destination_dir: charts
          keep_files: false
        continue-on-error: false

