name: Publish Docker Image and Helm Chart

# This workflow automatically builds and publishes Docker images to Docker Hub
# and Helm charts to GitHub Pages whenever a Git tag is created.
# 
# Prerequisites:
# - Docker Hub secrets: DOCKER_HUB_USERNAME, DOCKER_HUB_TOKEN
# - GitHub Pages must be enabled in repository settings
#
# Usage:
#   git tag 1.0.0
#   git push origin 1.0.0

on:
  push:
    tags:
      # Match semantic version tags without 'v' prefix (e.g., 1.0.0, 1.2.3-beta.1)
      - '[0-9]+.[0-9]+.[0-9]+*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for GitHub Pages deployment
      packages: write  # Required for Docker Hub push
    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history to ensure all files are available

      # Step 2: Validate Git tag format (semantic versioning without 'v' prefix)
      - name: Validate Git tag
        run: |
          if ! [[ "${{ github.ref_name }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Error: Tag must be semantic version without 'v' prefix (e.g., 1.0.0)"
            echo "Valid formats: 1.0.0, 1.2.3, 2.0.0-beta.1, 1.0.0+abc123"
            exit 1
          fi
          echo "✓ Validated tag: ${{ github.ref_name }}"

      # Step 3: Set up Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 4: Authenticate with Docker Hub using access token
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          registry: docker.io
        continue-on-error: false

      # Step 5: Build and push Docker image with version and latest tags
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            iklob1/pylight:${{ github.ref_name }}
            iklob1/pylight:latest
          platforms: linux/amd64
        continue-on-error: false

      # Step 6: Install Helm CLI for chart packaging
      - name: Set up Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      # Step 7: Clean up macOS resource fork files (._*) that cause Helm issues
      - name: Clean up macOS resource forks
        run: |
          find charts/pylight -name "._*" -type f -delete || true
          find charts/pylight -name ".DS_Store" -type f -delete || true
          echo "✓ Cleaned up macOS resource fork files"

      # Step 8: Update Chart.yaml version to match Git tag
      - name: Update Chart.yaml version
        run: |
          VERSION="${{ github.ref_name }}"
          CHART_FILE="charts/pylight/Chart.yaml"
          
          # Verify file exists before update
          if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart.yaml not found at $CHART_FILE"
            echo "Current directory: $(pwd)"
            echo "Files in charts/pylight:"
            ls -la charts/pylight/ || true
            exit 1
          fi
          
          # Use sed to update only the version line (preserves YAML structure)
          # This avoids corrupting multiline literal block scalars and other YAML formatting
          sed -i.bak "s/^version:.*/version: $VERSION/" "$CHART_FILE"
          rm -f "$CHART_FILE.bak"
          
          # Verify the update worked
          if ! grep -q "^version: $VERSION" "$CHART_FILE"; then
            echo "Error: Failed to update Chart.yaml version to $VERSION"
            echo "Current Chart.yaml content:"
            cat "$CHART_FILE"
            exit 1
          fi
          
          # Verify file is still valid YAML after update
          if ! python3 -c "import yaml; yaml.safe_load(open('$CHART_FILE'))" 2>/dev/null; then
            echo "Error: Chart.yaml is not valid YAML after version update"
            cat "$CHART_FILE"
            exit 1
          fi
          
          echo "✓ Updated Chart.yaml version to $VERSION"
          echo "Chart.yaml version line:"
          grep "^version:" "$CHART_FILE"

      # Step 9: Package Helm chart into .tgz archive
      - name: Package Helm chart
        run: |
          mkdir -p charts-dist
          CHART_DIR="charts/pylight"
          CHART_FILE="$CHART_DIR/Chart.yaml"
          
          # Verify Chart.yaml exists
          if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart.yaml not found at $CHART_FILE"
            exit 1
          fi
          
          # Create a temporary clean copy of the chart to avoid any path/subdirectory issues
          TEMP_CHART_DIR="/tmp/pylight-chart-$$"
          mkdir -p "$TEMP_CHART_DIR"
          
          # Copy entire chart directory to temp location
          cp -r "$CHART_DIR"/* "$TEMP_CHART_DIR/"
          
          # Verify Chart.yaml exists in temp location
          if [ ! -f "$TEMP_CHART_DIR/Chart.yaml" ]; then
            echo "Error: Chart.yaml not found in temp chart directory"
            exit 1
          fi
          
          # Package from temp directory
          cd "$TEMP_CHART_DIR"
          ABS_DEST="$(cd "${{ github.workspace }}/charts-dist" && pwd)"
          
          if ! helm package . --destination "$ABS_DEST"; then
            echo "Error: Helm chart packaging failed"
            # Cleanup
            rm -rf "$TEMP_CHART_DIR"
            exit 1
          fi
          
          echo "✓ Helm chart packaged successfully"
          
          # Cleanup temp directory
          rm -rf "$TEMP_CHART_DIR"
          
          # Return to workspace root
          cd "${{ github.workspace }}"

      # Step 10: Check if chart version already exists (prevent overwrite)
      - name: Check version conflict
        run: |
          VERSION="${{ github.ref_name }}"
          INDEX_URL="https://iklobato.github.io/pylight/charts/index.yaml"
          
          # Download existing index if it exists, validate it's proper YAML
          if curl -sf "$INDEX_URL" -o existing-index.yaml; then
            # Validate the downloaded file is valid YAML/JSON
            if ! python3 -c "import yaml; yaml.safe_load(open('existing-index.yaml'))" 2>/dev/null; then
              echo "Warning: Existing index file is not valid YAML, will create new index"
              rm -f existing-index.yaml
            else
              # Check if version already exists
              if grep -q "version: $VERSION" existing-index.yaml 2>/dev/null; then
                echo "Error: Chart version $VERSION already exists in repository"
                echo "Cannot publish duplicate version. Use a new version number."
                exit 1
              fi
              echo "✓ Version $VERSION is available for publishing"
            fi
          else
            echo "No existing index found, will create new one"
            touch existing-index.yaml
          fi

      # Step 11: Generate or update Helm repository index
      - name: Generate repository index
        run: |
          REPO_URL="https://iklobato.github.io/pylight/charts"
          
          # Check if existing-index.yaml exists and is valid
          if [ -f existing-index.yaml ] && [ -s existing-index.yaml ]; then
            # Validate it's proper YAML before merging
            if python3 -c "import yaml; yaml.safe_load(open('existing-index.yaml'))" 2>/dev/null; then
              echo "Merging with existing index..."
              if ! helm repo index ./charts-dist --url "$REPO_URL" --merge existing-index.yaml; then
                echo "Error: Failed to generate repository index with merge"
                exit 1
              fi
            else
              echo "Existing index is invalid, creating new index..."
              if ! helm repo index ./charts-dist --url "$REPO_URL"; then
                echo "Error: Failed to generate repository index"
                exit 1
              fi
            fi
          else
            echo "No existing index, creating new one..."
            if ! helm repo index ./charts-dist --url "$REPO_URL"; then
              echo "Error: Failed to generate repository index"
              exit 1
            fi
          fi
          
          echo "✓ Repository index generated successfully"

      # Step 12: Deploy chart package and index to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./charts-dist
          destination_dir: charts
          keep_files: false
        continue-on-error: false

